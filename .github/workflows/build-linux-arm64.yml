# इस वर्कफ़लो फ़ाइल का नाम
name: Build Bitcoin Core for Linux (ARM64)

# यह वर्कफ़्लो कब चलेगा?
on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

# वर्कफ़लो में किए जाने वाले काम (Jobs)
jobs:
  build-arm64:
    runs-on: ubuntu-latest
    
    steps:
      # स्टेप 1: सोर्स कोड को डाउनलोड करना
      - name: Checkout Bitcoin Core source code
        uses: actions/checkout@v4

      # स्टेप 2: QEMU सेट अप करना
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # स्टेप 3: ARM64 बिल्ड वातावरण बनाना
      - name: Build in ARM64 container
        run: |
          # हम वापस root के रूप में चल रहे हैं (डिफ़ॉल्ट)
          docker run --rm --platform linux/arm64 -v ${{ github.workspace }}:/workspace -w /workspace arm64v8/ubuntu:22.04 /bin/bash -c '
            set -e
            
            # 1. निर्भरताएँ इंस्टॉल करना (यह अब root के रूप में चलेगा और सफल होगा)
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y build-essential libtool autotools-dev automake pkg-config libssl-dev libevent-dev libboost-system-dev libboost-filesystem-dev libboost-test-dev libboost-thread-dev libsqlite3-dev git
            
            # 2. बिल्ड प्रक्रिया
            ./autogen.sh
            ./configure --without-gui --enable-wallet --disable-tests --disable-bench
            make -j$(nproc)
            
            # 3. परिणामी फाइलों को इकट्ठा करना
            mkdir -p /workspace/release_arm64/bin
            cp src/bitcoind /workspace/release_arm64/bin/
            cp src/bitcoin-cli /workspace/release_arm64/bin/
            
            echo "Build finished successfully!"
          '
      
      # स्टेप 4: बनी हुई फाइलों को एक आर्टिफैक्ट के रूप में अपलोड करना
      - name: Upload compiled ARM64 binaries
        uses: actions/upload-artifact@v4
        with:
          name: bitcoin-linux-arm64
          path: release_arm64/
